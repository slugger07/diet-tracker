<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutrition Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100vw !important;
            max-width: 100vw !important;
            overflow-x: hidden !important;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .settings-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
            z-index: 100;
            overflow-y: auto;
        }
        
        .settings-drawer.open {
            right: 0;
        }
        
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            display: none;
        }
        
        .drawer-overlay.show {
            display: block;
        }

        .meal-tab {
            padding: 10px 16px;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .meal-tab.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }

        .quick-log-card {
            min-width: 120px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .quick-log-card:active {
            transform: scale(0.95);
        }

        input, textarea, select {
            font-size: 16px !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Sticky Header -->
    <div class="sticky-header">
        <div class="px-4 py-3">
            <div class="flex justify-between items-center mb-2">
                <span class="text-lg font-bold text-gray-800">üìä Nutrition Tracker</span>
                <button id="settings-btn" class="text-2xl">‚öôÔ∏è</button>
            </div>
            <div class="text-sm font-medium mb-1">
                <span>Calories: <span id="header-calories">0</span>/<span id="header-target-calories">0</span></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                <div id="header-progress" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-600">
                <span>P: <span id="header-protein">0</span>/<span id="header-target-protein">0</span>g</span>
                <span>F: <span id="header-fat">0</span>/<span id="header-target-fat">0</span>g</span>
                <span>C: <span id="header-carbs">0</span>/<span id="header-target-carbs">0</span>g</span>
            </div>
        </div>
    </div>

    <!-- Settings Drawer Overlay -->
    <div id="drawer-overlay" class="drawer-overlay"></div>

    <!-- Settings Drawer -->
    <div id="settings-drawer" class="settings-drawer">
        <div class="p-5">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-2xl font-bold">‚öôÔ∏è Settings</h2>
                <button id="close-drawer-btn" class="text-3xl">&times;</button>
            </div>
            
            <h3 class="text-lg font-semibold mb-3">Daily Targets</h3>
            <div class="space-y-3 mb-5">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Calories</label>
                    <input type="number" id="settings-calories" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Protein (g)</label>
                    <input type="number" id="settings-protein" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Fat (g)</label>
                    <input type="number" id="settings-fat" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Carbs (g)</label>
                    <input type="number" id="settings-carbs" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg">
                </div>
            </div>
            <button id="update-targets-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">
                Update Targets
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pb-6">
        
        <!-- Loading & Error -->
        <div id="loading-spinner" class="spinner mx-auto my-5 hidden"></div>
        <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 px-4 py-3 text-base mx-4 my-4"></div>

        <!-- Log Food Section -->
        <div class="bg-white px-4 py-5 shadow-sm mb-4">
            <h2 class="text-2xl font-bold text-center mb-4">üçΩÔ∏è LOG YOUR FOOD</h2>
            
            <!-- Meal Type Selector -->
            <div class="flex justify-around border-b border-gray-200 mb-4">
                <div class="meal-tab active" data-meal="Breakfast">üåÖ Breakfast</div>
                <div class="meal-tab" data-meal="Lunch">üåû Lunch</div>
                <div class="meal-tab" data-meal="Dinner">üåô Dinner</div>
                <div class="meal-tab" data-meal="Snack">üç™ Snack</div>
            </div>
            
            <textarea id="food-input" rows="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg resize-none mb-4" placeholder="What did you eat? e.g., 2 eggs and toast"></textarea>
            
            <div class="grid grid-cols-2 gap-3">
                <button id="ai-log-btn" class="bg-blue-600 text-white font-bold py-4 rounded-lg text-lg">
                    ü§ñ AI Log
                </button>
                <button id="inventory-toggle-btn" class="bg-gray-600 text-white font-bold py-4 rounded-lg text-lg">
                    üì¶ Inventory
                </button>
            </div>
        </div>

        <!-- Quick Log - Recent Favorites -->
        <div class="bg-white px-4 py-5 shadow-sm mb-4">
            <h3 class="text-xl font-semibold mb-3">‚ö° Quick Log - Recent</h3>
            <div id="quick-log-container" class="flex overflow-x-auto gap-3 pb-2">
                <!-- Quick log items will be injected here -->
            </div>
        </div>

        <!-- Food Inventory (Collapsible) -->
        <div id="inventory-section" class="bg-white shadow-sm mb-4 hidden">
            <div class="px-4 py-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-semibold">üì¶ My Food Inventory</h3>
                    <button id="inventory-close-btn" class="text-2xl">&times;</button>
                </div>
                
                <input type="text" id="inventory-search" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-3" placeholder="üîç Search your saved foods...">
                
                <div id="inventory-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Inventory items will be injected here -->
                </div>
            </div>
        </div>

        <!-- Today's Log -->
        <div class="bg-white px-4 py-5 shadow-sm mb-4">
            <h3 class="text-xl font-semibold mb-4">üìù Today's Log</h3>
            <div id="todays-log-container">
                <!-- Today's log will be injected here -->
            </div>
        </div>

        <!-- Weekly Summary (Collapsible) -->
        <details class="bg-white shadow-sm mb-4">
            <summary class="px-4 py-4 text-xl font-semibold cursor-pointer">üìà This Week</summary>
            <div id="weekly-summary" class="px-4 pb-4">
                <!-- Weekly summary will be injected here -->
            </div>
        </details>

    </div>

    <script>
        // ============================================
        // CONFIGURATION - UPDATE THIS WITH YOUR API URL
        // ============================================
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbxyA-PhriXZMYOnjSz8nskmz6bpuAbSMatu-CNZzdchcWsJGAqnfDeMr9VSWAp6vPtaRw/exec'; 
        
        // ============================================
        // API HELPER FUNCTIONS
        // ============================================
        
        async function apiCall(endpoint, data = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}?action=${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // ============================================
        // STATE
        // ============================================
        let currentMeal = 'Breakfast';
        let currentTargets = {};
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsDrawer = document.getElementById('settings-drawer');
        const drawerOverlay = document.getElementById('drawer-overlay');
        const closeDrawerBtn = document.getElementById('close-drawer-btn');
        const updateTargetsBtn = document.getElementById('update-targets-btn');
        const aiLogBtn = document.getElementById('ai-log-btn');
        const inventoryToggleBtn = document.getElementById('inventory-toggle-btn');
        const inventorySection = document.getElementById('inventory-section');
        const inventoryCloseBtn = document.getElementById('inventory-close-btn');
        const inventorySearch = document.getElementById('inventory-search');

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function setLoading(isLoading) {
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = `Error: ${message}`;
            errorMessage.classList.remove('hidden');
            setLoading(false);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // SETTINGS DRAWER
        // ============================================
        
        settingsBtn.addEventListener('click', () => {
            settingsDrawer.classList.add('open');
            drawerOverlay.classList.add('show');
        });

        closeDrawerBtn.addEventListener('click', closeDrawer);
        drawerOverlay.addEventListener('click', closeDrawer);

        function closeDrawer() {
            settingsDrawer.classList.remove('open');
            drawerOverlay.classList.remove('show');
        }

        updateTargetsBtn.addEventListener('click', async () => {
            setLoading(true);
            try {
                const targets = {
                    calories: document.getElementById('settings-calories').value,
                    protein: document.getElementById('settings-protein').value,
                    fat: document.getElementById('settings-fat').value,
                    carbs: document.getElementById('settings-carbs').value,
                };
                const data = await apiCall('setTodaysTarget', { targets });
                updateDashboard(data);
                closeDrawer();
            } catch (error) {
                showError(error.message);
            }
        });

        // ============================================
        // MEAL TAB SELECTION
        // ============================================
        
        document.querySelectorAll('.meal-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.meal-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentMeal = tab.getAttribute('data-meal');
            });
        });

        // ============================================
        // UPDATE DASHBOARD
        // ============================================
        
        function updateDashboard(data) {
            setLoading(false);
            if (data.error) {
                return showError(data.error);
            }

            const { loggedItems, totals, targets, suggestedMeal } = data;
            currentTargets = targets;

            // Update Settings Drawer
            document.getElementById('settings-calories').value = targets.calories || '';
            document.getElementById('settings-protein').value = targets.protein || '';
            document.getElementById('settings-fat').value = targets.fat || '';
            document.getElementById('settings-carbs').value = targets.carbs || '';

            // Update Sticky Header
            document.getElementById('header-calories').textContent = Math.round(totals.calories);
            document.getElementById('header-target-calories').textContent = Math.round(targets.calories);
            document.getElementById('header-protein').textContent = Math.round(totals.protein);
            document.getElementById('header-target-protein').textContent = Math.round(targets.protein);
            document.getElementById('header-fat').textContent = Math.round(totals.fat);
            document.getElementById('header-target-fat').textContent = Math.round(targets.fat);
            document.getElementById('header-carbs').textContent = Math.round(totals.carbs);
            document.getElementById('header-target-carbs').textContent = Math.round(targets.carbs);

            const percent = (targets.calories > 0) ? (totals.calories / targets.calories) * 100 : 0;
            const headerProgress = document.getElementById('header-progress');
            headerProgress.style.width = `${Math.min(percent, 100)}%`;
            headerProgress.className = percent > 100 ? 'bg-red-600 h-2 rounded-full transition-all' : 'bg-blue-600 h-2 rounded-full transition-all';

            // Set suggested meal
            if (suggestedMeal) {
                currentMeal = suggestedMeal;
                document.querySelectorAll('.meal-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-meal="${suggestedMeal}"]`)?.classList.add('active');
            }

            // Update Today's Log
            renderTodaysLog(loggedItems);
            
            // Load other sections
            loadQuickLog();
            loadInventory('');
            loadWeeklySummary();
        }

        // ============================================
        // RENDER TODAY'S LOG
        // ============================================
        
        function renderTodaysLog(loggedItems) {
            const container = document.getElementById('todays-log-container');
            container.innerHTML = '';

            const meals = ['Breakfast', 'Lunch', 'Snack', 'Dinner'];
            const mealIcons = { 'Breakfast': 'üåÖ', 'Lunch': 'üåû', 'Snack': 'üç™', 'Dinner': 'üåô' };

            meals.forEach(mealType => {
                const items = loggedItems[mealType] || [];
                
                const mealSection = document.createElement('div');
                mealSection.className = 'mb-4';
                
                let subtotal = 0;
                let mealHtml = `<div class="font-semibold text-lg mb-2">${mealIcons[mealType]} ${mealType.toUpperCase()}</div>`;
                
                if (items.length === 0) {
                    mealHtml += `<div class="text-gray-400 text-sm mb-2">No items logged</div>`;
                } else {
                    items.forEach(item => {
                        subtotal += item.calories;
                        mealHtml += `
                            <div class="border-b border-gray-200 pb-2 mb-2">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-medium text-base flex-1">${escapeHtml(item.item)}</span>
                                    <span class="font-bold text-base ml-2">${Math.round(item.calories)} cal</span>
                                    <button class="delete-btn ml-2 text-red-500 font-bold" data-row="${item.rowId}">√ó</button>
                                </div>
                                <div class="text-sm text-gray-600">
                                    P: ${Math.round(item.protein)}g | F: ${Math.round(item.fat)}g | C: ${Math.round(item.carbs)}g
                                </div>
                                <div class="text-xs text-gray-400">${item.timestamp}</div>
                            </div>
                        `;
                    });
                    mealHtml += `<div class="text-sm font-medium">Subtotal: ${Math.round(subtotal)} cal</div>`;
                }
                
                mealHtml += `<hr class="my-3">`;
                mealSection.innerHTML = mealHtml;
                container.appendChild(mealSection);
            });

            // Attach delete handlers
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const rowId = e.target.getAttribute('data-row');
                    if (confirm('Delete this item?')) {
                        setLoading(true);
                        try {
                            const data = await apiCall('deleteLogItem', { rowId: parseInt(rowId) });
                            updateDashboard(data);
                        } catch (error) {
                            showError(error.message);
                        }
                    }
                });
            });
        }

        // ============================================
        // QUICK LOG
        // ============================================
        
        async function loadQuickLog() {
            try {
                const data = await apiCall('getQuickLogItems');
                if (data.error) return;
                renderQuickLog(data.items);
            } catch (error) {
                console.error('Quick log error:', error);
            }
        }

        function renderQuickLog(items) {
            const container = document.getElementById('quick-log-container');
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm">No recent items</div>';
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'quick-log-card bg-gray-50 border-2 border-gray-200 rounded-lg p-3 text-center';
                card.innerHTML = `
                    <div class="font-medium text-sm mb-1">${escapeHtml(item.item)}</div>
                    <div class="text-xs text-gray-600 mb-2">${Math.round(item.calories)} cal</div>
                    <button class="quick-log-btn bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">+</button>
                `;
                
                card.querySelector('.quick-log-btn').addEventListener('click', async () => {
                    setLoading(true);
                    try {
                        const data = await apiCall('quickLogFood', {
                            itemName: item.item,
                            calories: item.calories,
                            protein: item.protein,
                            fat: item.fat,
                            carbs: item.carbs,
                            mealType: currentMeal
                        });
                        updateDashboard(data);
                    } catch (error) {
                        showError(error.message);
                    }
                });
                
                container.appendChild(card);
            });
        }

        // ============================================
        // INVENTORY
        // ============================================
        
        inventoryToggleBtn.addEventListener('click', () => {
            inventorySection.classList.toggle('hidden');
            if (!inventorySection.classList.contains('hidden')) {
                loadInventory('');
            }
        });

        inventoryCloseBtn.addEventListener('click', () => {
            inventorySection.classList.add('hidden');
        });

        inventorySearch.addEventListener('input', (e) => {
            loadInventory(e.target.value);
        });

        async function loadInventory(searchQuery) {
            try {
                const data = await apiCall('getInventoryItems', { searchQuery });
                if (data.error) return;
                renderInventory(data.items);
            } catch (error) {
                console.error('Inventory error:', error);
            }
        }

        function renderInventory(items) {
            const container = document.getElementById('inventory-list');
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm">No items in inventory</div>';
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-3';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-medium flex-1">${escapeHtml(item.name)}</span>
                        <button class="inventory-log-btn bg-green-600 text-white px-3 py-1 rounded text-sm font-bold">+</button>
                    </div>
                    <div class="text-xs text-gray-600">
                        ${Math.round(item.calories)} cal ‚Ä¢ P: ${Math.round(item.protein)}g F: ${Math.round(item.fat)}g C: ${Math.round(item.carbs)}g
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        ${item.isFavorite ? '‚≠ê Favorite' : ''} ‚Ä¢ Used ${item.timesUsed} times
                    </div>
                `;
                
                div.querySelector('.inventory-log-btn').addEventListener('click', async () => {
                    setLoading(true);
                    try {
                        const data = await apiCall('quickLogFood', {
                            itemName: item.name,
                            calories: item.calories,
                            protein: item.protein,
                            fat: item.fat,
                            carbs: item.carbs,
                            mealType: currentMeal
                        });
                        updateDashboard(data);
                    } catch (error) {
                        showError(error.message);
                    }
                });
                
                container.appendChild(div);
            });
        }

        // ============================================
        // WEEKLY SUMMARY
        // ============================================
        
        async function loadWeeklySummary() {
            try {
                const data = await apiCall('getWeeklySummary');
                if (data.error) return;
                renderWeeklySummary(data);
            } catch (error) {
                console.error('Weekly summary error:', error);
            }
        }

        function renderWeeklySummary(data) {
            const container = document.getElementById('weekly-summary');
            container.innerHTML = `
                <div class="space-y-3">
                    <div><strong>Week:</strong> ${data.weekStart} - ${data.weekEnd}</div>
                    <div><strong>Days Tracked:</strong> ${data.daysTracked}/7</div>
                    <div>
                        <strong>Avg Daily:</strong><br>
                        ‚Ä¢ Calories: ${data.avgDaily.calories} (target: ${Math.round(data.target.calories)})<br>
                        ‚Ä¢ Protein: ${data.avgDaily.protein}g (target: ${Math.round(data.target.protein)}g)<br>
                        ‚Ä¢ Fat: ${data.avgDaily.fat}g (target: ${Math.round(data.target.fat)}g)<br>
                        ‚Ä¢ Carbs: ${data.avgDaily.carbs}g (target: ${Math.round(data.target.carbs)}g)
                    </div>
                    <div>
                        <strong>Week Total:</strong><br>
                        ‚Ä¢ Calories: ${Math.round(data.weekTotal.calories)}<br>
                        ‚Ä¢ Protein: ${Math.round(data.weekTotal.protein)}g<br>
                        ‚Ä¢ Fat: ${Math.round(data.weekTotal.fat)}g<br>
                        ‚Ä¢ Carbs: ${Math.round(data.weekTotal.carbs)}g
                    </div>
                </div>
            `;
        }

        // ============================================
        // AI LOG
        // ============================================
        
        aiLogBtn.addEventListener('click', async () => {
            const rawText = document.getElementById('food-input').value;
            if (!rawText) {
                showError("Please enter what you ate.");
                return;
            }
            
            setLoading(true);
            try {
                const data = await apiCall('logFood', {
                    rawText,
                    mealType: currentMeal
                });
                updateDashboard(data);
                document.getElementById('food-input').value = '';
            } catch (error) {
                showError(error.message);
            }
        });

        // ============================================
        // INITIAL LOAD
        // ============================================
        
        async function loadInitialData() {
            setLoading(true);
            try {
                const data = await apiCall('getTodaysData');
                updateDashboard(data);
            } catch (error) {
                showError(error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', loadInitialData);
    </script>
</body>
</html>
